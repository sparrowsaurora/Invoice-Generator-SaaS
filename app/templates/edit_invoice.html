{% extends "index.html" %} {% block content %}
<h1 class="mb-4">Edit Invoice</h1>
<form method="POST" class="needs-validation" novalidate>
    <div class="mb-3">
        <label class="form-label">Client Name</label>
        <input
            name="client_name"
            class="form-control"
            value="{{ invoice.client_name }}"
            required
        />
    </div>
    <div class="mb-3">
        <label class="form-label">Company Name</label>
        <input
            name="company_name"
            class="form-control"
            value="{{ invoice.company_name }}"
            required
        />
    </div>
    <div class="mb-3">
        <label class="form-label">Service Provided</label>
        <input
            name="service"
            class="form-control"
            value="{{ invoice.service }}"
            required
        />
    </div>
    <div class="mb-3">
        <label class="form-label">Amount ($)</label>
        <input
            name="amount"
            type="number"
            step="0.01"
            class="form-control"
            value="{{ invoice.amount }}"
            required
        />
    </div>
    <div class="mb-3">
        <label class="form-label">Invoice Date</label>
        <input
            name="date"
            type="date"
            class="form-control"
            value="{{ invoice.date }}"
        />
    </div>
    <div class="mb-3">
        <label class="form-label">Due Date</label>
        <input
            name="due_date"
            type="date"
            class="form-control"
            value="{{ invoice.due_date }}"
        />
    </div>
    <div class="mb-3">
        <label class="form-label">Invoice Items</label>
        <table class="table" id="items-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Quantity</th>
                    <th>Unit Price ($)</th>
                    <th>
                        <button
                            type="button"
                            class="btn btn-sm btn-success"
                            onclick="addItemRow()"
                        >
                            +
                        </button>
                    </th>
                </tr>
            </thead>
            <tbody id="items-body">
                <!-- JS will fill rows -->
            </tbody>
        </table>
        <input type="hidden" name="items" id="items-json" />
    </div>

    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>
<script>
    function addItemRow(desc = "", qty = 1, price = 0.0) {
        const tbody = document.getElementById("items-body");
        const row = document.createElement("tr");

        row.innerHTML = `
            <td><input type="text" class="form-control" value="${desc}" /></td>
            <td><input type="number" class="form-control" value="${qty}" min="1" /></td>
            <td><input type="number" class="form-control" value="${price}" min="0" step="0.01" /></td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">x</button></td>
        `;

        tbody.appendChild(row);
    }

    function gatherItems() {
        const rows = document.querySelectorAll("#items-body tr");
        const items = [];

        rows.forEach((row) => {
            const cells = row.querySelectorAll("input");
            items.push({
                description: cells[0].value,
                quantity: parseInt(cells[1].value),
                unit_price: parseFloat(cells[2].value),
            });
        });

        document.getElementById("items-json").value = JSON.stringify(items);
    }

    document.querySelector("form").addEventListener("submit", gatherItems);
</script>

{% endblock %}
